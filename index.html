<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°è‚¡æŠ•è³‡è¨˜å¸³ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰</title>
<style>
:root{
  --bg:#f5f6fa;
  --card:#ffffff;
  --primary:#1f3a5f;
  --buy:#2c6bed;
  --sell:#d64545;
  --pos:#1a7f37;
  --neg:#c0392b;
  --text:#333;
  --muted:#777;
  --btn:#1f3a5f;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:var(--bg);
  margin:0;padding:10px;color:var(--text);
}
h2{margin:10px 0;color:var(--primary);font-size:18px;}
.card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 6px 15px rgba(0,0,0,.06);
}
input,select,button,textarea{
  width:100%;
  padding:8px;
  margin:5px 0;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:14px;
}
textarea{resize:none}
button{background:var(--btn);color:#fff;border:none;font-weight:600;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{border-bottom:1px solid #eee;padding:6px;text-align:center;}
.buy{color:var(--buy);}
.sell{color:var(--sell);}
.pos{color:var(--pos); font-weight:600;}
.neg{color:var(--neg); font-weight:600;}
.muted{color:var(--muted);}
.badge{font-size:11px;padding:2px 6px;border-radius:999px;background:#eee;}
</style>
</head>
<body>

<!-- è³‡é‡‘èˆ‡è‚¡æ¯ -->
<div class="card">
<h2>ğŸ’° è³‡é‡‘èˆ‡è‚¡æ¯</h2>
<input type="number" id="deposit" placeholder="å­˜å…¥è³‡é‡‘">
<button onclick="addDeposit()">å­˜å…¥è³‡é‡‘</button>

<input type="number" id="dividend" placeholder="è‚¡æ¯æ”¶å…¥">
<textarea id="divNote" placeholder="è‚¡æ¯å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
<button onclick="addDividend()">æ–°å¢è‚¡æ¯</button>

<p class="muted">ç›®å‰é¤˜é¡ï¼š<b id="balance">0</b></p>
<p class="muted">ç´¯è¨ˆè‚¡æ¯ï¼š<b id="divTotal">0</b></p>
<p class="muted">è‚¡æ¯æœˆæ”¶å…¥ï¼š<b id="divMonth">0</b>ï¼Œå¹´æ”¶å…¥ï¼š<b id="divYear">0</b></p>
</div>

<!-- æ–°å¢äº¤æ˜“ -->
<div class="card">
<h2>ğŸ“ˆ æ–°å¢äº¤æ˜“</h2>
<input type="date" id="date">
<input type="text" id="stock" placeholder="è‚¡ç¥¨ä»£è™Ÿ">
<select id="term">
  <option value="çŸ­æœŸ">çŸ­æœŸ</option>
  <option value="é•·æœŸ">é•·æœŸ</option>
</select>
<select id="type">
  <option value="è²·">è²·</option>
  <option value="è³£">è³£</option>
</select>
<input type="number" id="shares" placeholder="è‚¡æ•¸">
<input type="number" id="price" placeholder="æˆäº¤åƒ¹">
<input type="number" id="tax" placeholder="æ‰‹å‹•ç¨…é‡‘">
<p class="muted" style="font-size:12px;">è²¼å£«ï¼šæ­·å²ç¨…é‡‘ = æˆäº¤é‡‘é¡ x 0.3% (è­‰äº¤ç¨…) + æ‰‹çºŒè²» x 0.1425%</p>
<textarea id="note" placeholder="å‚™è¨»ï¼ˆç­–ç•¥ã€æƒ³æ³•ï¼‰"></textarea>
<button onclick="addTrade()">æ–°å¢äº¤æ˜“</button>
</div>

<!-- äº¤æ˜“ç´€éŒ„ -->
<div class="card">
<h2>ğŸ“‹ äº¤æ˜“ç´€éŒ„</h2>
<table>
<thead>
<tr>
<th>æ—¥æœŸ</th><th>è‚¡ç¥¨</th><th>é¡å‹</th><th>çŸ­/é•·æœŸ</th><th>è‚¡æ•¸</th><th>æˆäº¤åƒ¹</th><th>ç¨…é‡‘</th><th>ç¸½é‡‘é¡</th><th>å‚™è¨»</th>
</tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

<!-- æŒè‚¡æˆæœ¬ / æœªå¯¦ç¾æç›Š -->
<div class="card">
<h2>ğŸ“Š æŒè‚¡æˆæœ¬ / æœªå¯¦ç¾æç›Š</h2>
<table>
<thead>
<tr>
<th>è‚¡ç¥¨</th><th>æŒè‚¡è‚¡æ•¸</th><th>æˆæœ¬</th><th>æœªå¯¦ç¾æç›Š</th>
</tr>
</thead>
<tbody id="holding"></tbody>
</table>
</div>

<!-- é¸å–è‚¡ç¥¨æŸ¥çœ‹æ­·å²æç›Šèˆ‡è‚¡æ¯ -->
<div class="card">
<h2>ğŸ” è‚¡ç¥¨ç¸½æç›Š & è‚¡æ¯</h2>
<select id="stockSelect" onchange="showStockSummary()">
<option value="">è«‹é¸æ“‡è‚¡ç¥¨</option>
</select>
<p>å·²å¯¦ç¾ + æœªå¯¦ç¾æç›Šï¼š<b id="stockProfit">0</b></p>
<p>è‚¡æ¯æœˆæ”¶å…¥ï¼š<b id="stockDivMonth">0</b>ï¼Œå¹´æ”¶å…¥ï¼š<b id="stockDivYear">0</b></p>
</div>

<!-- åŒ¯å‡º Excel -->
<div class="card">
<h2>ğŸ“Š å ±è¡¨</h2>
<button onclick="exportExcel()">åŒ¯å‡º Excel</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let data = JSON.parse(localStorage.getItem("stockBook")) || {balance:0, dividend:0, trades:[]};
date.valueAsDate = new Date();

function save(){localStorage.setItem("stockBook", JSON.stringify(data));}
function addDeposit(){let v=+deposit.value;if(!v)return;data.balance+=v;deposit.value="";save();render();}
function addDividend(){let v=+dividend.value;if(!v)return;let d=new Date();data.balance+=v;data.dividend+=v;data.trades.push({d:d.toISOString().slice(0,10),s:"è‚¡æ¯",t:"æ”¶å…¥",term:"-",sh:0,p:0,tax:0,total:v,n:divNote.value});dividend.value="";divNote.value="";save();render();}
function addTrade(){let d=date.value,s=stock.value,termV=term.value,t=type.value,sh=+shares.value,p=+price.value,tx=+tax.value;if(!d||!s||!sh||!p)return;let amt=sh*p,total=(t==="è²·"?amt:-amt)+tx;data.balance-=total;data.trades.push({d,s,t,term:termV,sh,p,tax:tx,total,n:note.value});stock.value=shares.value=price.value=tax.value=note.value="";save();render();}
function render(){
  balance.innerText=data.balance;
  divTotal.innerText=data.dividend;
  let divMonth=0,divYear=0;
  let now=new Date();
  data.trades.forEach(x=>{if(x.s==="è‚¡æ¯"){let dt=new Date(x.d);if(dt.getFullYear()===now.getFullYear()) divYear+=x.total;if(dt.getMonth()===now.getMonth()&&dt.getFullYear()===now.getFullYear()) divMonth+=x.total;}});
  divMonthElem=document.getElementById("divMonth"); divYearElem=document.getElementById("divYear");
  divMonthElem.innerText=divMonth.toFixed(2); divYearElem.innerText=divYear.toFixed(2);

  let r="";data.trades.forEach(x=>{r+=`<tr><td>${x.d.slice(5)}</td><td>${x.s}</td><td class="${x.t==="è²·"?"buy":x.t==="è³£"?"sell":"pos"}">${x.t}</td><td><span class="badge">${x.term||"-"}</span></td><td>${x.sh}</td><td>${x.p}</td><td>${x.tax}</td><td>${x.total}</td><td>${x.n}</td></tr>`;});
  records.innerHTML=r;

  let hold={},holdingHtml="";
  data.trades.forEach(x=>{if(x.s==="è‚¡æ¯") return;if(!hold[x.s]) hold[x.s]={qty:0,cost:0};if(x.t==="è²·"){hold[x.s].cost=(hold[x.s].cost*hold[x.s].qty+x.p*x.sh)/(hold[x.s].qty+x.sh);hold[x.s].qty+=x.sh;}else if(x.t==="è³£"){hold[x.s].qty-=x.sh;}});
  for(let k in hold){let unReal=hold[k].qty*hold[k].cost;holdingHtml+=`<tr><td>${k}</td><td>${hold[k].qty}</td><td>${hold[k].cost.toFixed(2)}</td><td>${unReal.toFixed(2)}</td></tr>`;}
  holding.innerHTML=holdingHtml;

  let stockSelect=document.getElementById("stockSelect");
  let stocks=[...new Set(data.trades.filter(x=>x.s!=="è‚¡æ¯").map(x=>x.s))];
  stockSelect.innerHTML=`<option value="">è«‹é¸æ“‡è‚¡ç¥¨</option>`+stocks.map(x=>`<option value="${x}">${x}</option>`).join('');
}
function showStockSummary(){
  let sel=document.getElementById("stockSelect").value;if(!sel){document.getElementById("stockProfit").innerText=0;document.getElementById("stockDivMonth").innerText=0;document.getElementById("stockDivYear").innerText=0;return;}
  let profit=0,divMonth=0,divYear=0;let now=new Date();let qty=0,cost=0;
  data.trades.forEach(x=>{
    if(x.s===sel){if(x.t==="è²·"){cost=(cost*qty+x.p*x.sh)/(qty+x.sh);qty+=x.sh;}else if(x.t==="è³£"){profit+=x.sh*(x.p-cost);qty-=x.sh;}}
    if(x.s==="è‚¡æ¯" && x.n.includes(sel)){let dt=new Date(x.d);if(dt.getFullYear()===now.getFullYear()) divYear+=x.total;if(dt.getMonth()===now.getMonth()&&dt.getFullYear()===now.getFullYear()) divMonth+=x.total;}
  });
  profit+=qty*cost;
  document.getElementById("stockProfit").innerText=profit.toFixed(2);
  document.getElementById("stockDivMonth").innerText=divMonth.toFixed(2);
  document.getElementById("stockDivYear").innerText=divYear.toFixed(2);
}
function exportExcel(){
  let wb=XLSX.utils.book_new();
  let tradeData=[["æ—¥æœŸ","è‚¡ç¥¨","é¡å‹","çŸ­/é•·æœŸ","è‚¡æ•¸","æˆäº¤åƒ¹","ç¨…é‡‘","ç¸½é‡‘é¡","å‚™è¨»"]];
  data.trades.forEach(x=>tradeData.push([x.d,x.s,x.t,x.term,x.sh,x.p,x.tax,x.total,x.n]));
  let ws=XLSX.utils.aoa_to_sheet(tradeData);
  XLSX.utils.book_append_sheet(wb,ws,"äº¤æ˜“ç´€éŒ„");
  XLSX.writeFile(wb,"stock_record.xlsx");
}
render();
</script>
</body>
</html>
